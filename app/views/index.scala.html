@(title: String, search: String, pagination: controllers.Application.Pagination, currentFolder: String, assets: scala.collection.immutable.List[models.Asset], library: models.AssetLibrary, individualAsset: Option[models.Asset], keywordSearch: String)


@*******************************
 * useful functions!
 *@


@listFolders(folders: Seq[models.AssetFolder], folderPath: String) = {
  @if(!folders.isEmpty) {
    <ul>
    @for(f <- folders) {
        @showFolder(f, folderPath + f.name + "/")
    }
    </ul>
  } 
}

@showFolder(folder: models.AssetFolder, folderPath: String) = {
    <li data-folder-path="@{folderPath}" data-query-url="@routes.Application.findFolder(folderPath, 1)">
        <a href="#">@{folder.name}</a>
        @listFolders(folder.folders, folderPath)
    </li>
}

@listKeywords(keywords: Seq[String]) = {
  <ul>
  @for(key <- keywords) {
    <li data-keyword="@{key}" data-query-url="@routes.Application.index("", key, 1)">
      <a href="#">@{key}</a>
    </li>
  }
  </ul>
}

@displayName(name: String) = {
    @if(name.length > 16) {
        @{name.substring(0,16) + "..."}
    } else {
        @{name}
    }
}

@assetThumbnail(a: models.Asset) = {    
  <div class="asset pull-left">
    <div class="inner-asset">
      <a href="@routes.Application.showAsset(a.original)">
      <img class="thumb" 
        src="@if(a.hasThumbnail) { @routes.FileServer.serve(a.thumbnail) } else { http://placehold.it/96x96 }"/>
      </a>
      <p class="caption">
        <a href="@routes.Application.showAsset(a.original)" rel="tooltip" title="@{a.name}" data-placement="bottom">@displayName(a.name)</a>
      </p>
    </div>
  </div>
}

@showIndividualAsset(a: models.Asset) = {
  <div class="assetDetail">
    <h1 class="title">@{a.name}</h1>
    <a href="@routes.FileServer.serve(a.original)">
    <img class="preview"
      src="@if(a.hasPreview) { @routes.FileServer.serve(a.preview) } else { http://placehold.it/320x320 }"/>
    </a>
    <dl class="dl-horizontal">
      @if(!a.description.isEmpty) {
        <dt>Description</dt>
        <dd>@{a.description}</dd>
      }
      <dt>Folder</dt>
      <dd><a href="@routes.Application.findFolder(a.folderPath,1)">@{a.folderPath}</a></dd>
      @if(!a.keywords.isEmpty) {
      <dt>Keywords</dt>
      <dd>
        @for(key <- a.keywords) {
          <a href="@routes.Application.index("",key, 1)">@key</a>, 
        }
      }
    </dl>
    <a class="btn btn-primary" href="@routes.FileServer.serve(a.original)">Download</a>
  </div>
}

@pageLink(page: Int, text: String, nav: Boolean) = {
  <li @if(page == pagination.current) { 
        @if(nav) { class="disabled" } else { class="active" }
    } >
    <a 
    href="@if(currentFolder.isEmpty) { @routes.Application.index(search, keywordSearch,page) } else { @routes.Application.findFolder(currentFolder,page) }"
      >@text</a>
  </li> 
}





@*******************************
 * the actual page starts here 
 *@

@main(title) {

@********************************
 * Navigation bar 
 *@

<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <a class="brand titlebrand" href="#">@{title}</a>
    <ul class="nav">
      <li class="divider-vertical"></li>
      <li @if(search.isEmpty && currentFolder.isEmpty && individualAsset.isEmpty && keywordSearch.isEmpty) { class="active" } ><a href="/">Show All</a></li> 
      <form class="navbar-form pull-left" action="@routes.Application.index()">
        <input type="text" name="search" id="search" class="span2" value="@{search}"/>
        <button type="submit" class="btn">Submit</button>
      </form>
    </ul>

@if(pagination.total > 1) {
    <div class="pagination pagination-small pull-left pagination-in-navbar">
    <ul>
        @pageLink(1, "|<", true) 
        @pageLink(math.max(pagination.current - 1,1), "<", true)
        @for(p <- pagination.min to pagination.max)  {
            @pageLink(p, p.toString, false)
        }
        @pageLink(math.min(pagination.current + 1, pagination.total), ">", true)
        @pageLink(pagination.total, ">|", true)
    </ul>
    </div> 
}
    @**** todo: order ****@
    @* <li class="navbar-text">Order</li> *@

@if(util.Settings.isAdmin) {
  @* show admin *@
  <ul class="nav pull-right">
    <li class="dropdown">
      <a class="dropdown-toggle" data-toggle="dropdown" href="#">Admin
          <b class="caret"></b>
        </a>
      <ul class="dropdown-menu">
        <a href="@routes.Application.rescan()">Rescan</a>
      </ul>
    </li>
  </ul>
}

  </div>
</div>

<div class="container-fluid rounded">
  <div class="row-fluid">

@*******************************
 * sidebar 
 *@

    <div class="span2 sidebar">
      <h5>Folders</h5>
      <div class="tree" id="folderTree" style="display:none;">
        @listFolders(library.topFolder.folders, "")
      </div>

      <h5>Keywords</h5>
      <div class="tree" id="keywordTree" style="display:none;">
        @listKeywords(library.keywords)
      </div>
    </div>

@*******************************
 * actual content 
 *@

    <div class="span10 content">
@if(individualAsset.isDefined) {
    @showIndividualAsset(individualAsset.get)  
} else {     
    @for(a <- assets) { @assetThumbnail(a) }
}
    </div>
  </div>
</div>

} @* end of main() call *@


@******************
 * scripts to run after other scripts are loaded ...
 * TODO: move these out to other js files to speed up loading
 *@

<script>
jQuery(document).ready(function() {

  // build a big lookup table from path -> node id
  var currentFolder = "@Html(currentFolder)";
  //console.log("looking for", currentFolder);
  var auto_open = [];
  var expect_select = false;
  // var nodes = [];
      
  // replace string path with hash id for easy lookup later...
  $(".tree li").each(function(index) { 
    var nodeName = $(this).attr("data-folder-path");
    var nodeId = "folder" + index;
    //nodes[ nodeName ] = nodeId; 
    $(this).attr("id", nodeId);

    if (nodeName === currentFolder) {
      auto_open.push("#" + nodeId);
      expect_select = true;
    } 
  });

  // create tree
  $("#folderTree").hide()
  .jstree({
      core: {
          "animation": 100,
          "open_parents": true
      },
      themes: { 
          "icons" : false,
          "theme": "classic",
          "url": "/web/tree-themes/classic/style.css"
      },
      ui: {
          "initially_select": auto_open
      }, 
      plugins: [ "themes",  "html_data", "ui" ]
  })
  .bind("select_node.jstree", function(e, data) {
    if (data.rslt.obj) {
      if (expect_select) {
        expect_select = false;
      } else {
        // redirect! (eventually, just submit query)
        window.location.href = data.rslt.obj.attr("data-query-url");
      }
    }
  }).show();


  var currentKeyword = "@Html(keywordSearch)";
  var keyword_to_open = [];
  var expect_keyword_select = false;
  // var keyNodes = [];

  $(".tree li").each(function(index) { 
    var nodeName = $(this).attr("data-keyword");
    var nodeId = "keyword" + index;
    //keyNodes[ nodeName ] = nodeId; 
    $(this).attr("id", nodeId);

    if (nodeName === currentKeyword) {
      keyword_to_open.push("#" + nodeId);
      expect_keyword_select = true;
    } 
  });

  $("#keywordTree").hide()
  .jstree({
      core: {
          "animation": 100
      },
      themes: { 
          "icons" : false,
          "theme": "classic",
          "url": "/web/tree-themes/classic/style.css"
      },
      ui: {
          "initially_select": keyword_to_open
      }, 
      plugins: [ "themes",  "html_data", "ui" ]
  })
  .bind("select_node.jstree", function(e, data) {
    if (data.rslt.obj) {
      if (expect_keyword_select) {
        expect_keyword_select = false;
      } else {
        // redirect! (eventually, just submit query)
        window.location.href = data.rslt.obj.attr("data-query-url");
      }
    }   
  }).show();


});
</script>

@* end page correctly *@
</body>
</html>

