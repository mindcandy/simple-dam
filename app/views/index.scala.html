@(results: controllers.Application.SearchResult, title: String, search: String, currentFolder: String, library: models.AssetLibrary, individualAsset: Option[models.Asset], keywordSearch: String)(implicit request: play.api.mvc.RequestHeader)


@*******************************
 * useful functions!
 *@

@listFolders(folders: Seq[models.AssetFolder], folderPath: String) = {
  @if(!folders.isEmpty) {
    <ul>
    @for(f <- folders) {
        @showFolder(f, folderPath + f.name + "/")
    }
    </ul>
  } 
}

@showFolder(folder: models.AssetFolder, folderPath: String) = {
    <li data-folder-path="@{folderPath}" data-query-url="@routes.Application.findFolder(folderPath, 1)">
        <a href="#">@{folder.name}</a>
        @listFolders(folder.folders, folderPath)
    </li>
}

@listKeywords(keywords: Seq[String]) = {
  <ul>
  @for(key <- keywords) {
    <li data-keyword="@{key}" data-query-url="@routes.Application.index("", key, 1)">
      <a href="#">@{key}</a>
    </li>
  }
  </ul>
}

@displayName(name: String) = {
    @if(name.length > 16) {
        @{name.substring(0,16) + "..."}
    } else {
        @{name}
    }
}

@imgSrcThumbnail(a: models.Asset) = {
  @if(a.hasThumbnail) {
    @if(util.Settings.isAdmin) {
      src="@routes.FileServer.serve(a.thumbnail)?bust=@{library.loadedAt}"
    } else {
      src="@routes.FileServer.serve(a.thumbnail)"
    }
  } else {
    @* placeholder *@
    src="http://placehold.it/96x96"
  } 
}

@imgSrcPreview(a: models.Asset) = {
  @if(a.hasThumbnail) {
    @if(util.Settings.isAdmin) {
      src="@routes.FileServer.serve(a.preview)?bust=@{library.loadedAt}"
    } else {
      src="@routes.FileServer.serve(a.preview)"
    }
  } else {
    @* placeholder *@
    src="http://placehold.it/320x320"
  } 
}

@assetThumbnail(a: models.Asset) = {    
  <div class="asset pull-left">
    <div class="inner-asset">
      <a href="@routes.Application.showAsset(a.original)">
      <img class="thumb" @imgSrcThumbnail(a) />
      </a>
      <p class="caption">
        <a href="@routes.Application.showAsset(a.original)" rel="tooltip" title="@{a.name}" data-placement="bottom">@displayName(a.name)</a>
      </p>
    </div>
  </div>
}

@showIndividualAsset(a: models.Asset) = {
  <div class="assetDetail">
    <h1 class="title">@{a.name}</h1>
    <a href="@routes.FileServer.serve(a.original)">
    <img class="preview" @imgSrcPreview(a) />
    </a>
    <dl class="dl-horizontal">
      @if(!a.description.isEmpty) {
        <dt>Description</dt>
        <dd>@{a.description}</dd>
      }
      <dt>Folder</dt>
      <dd><a href="@routes.Application.findFolder(a.folderPath,1)">@{a.folderPath}</a></dd>
      @if(!a.keywords.isEmpty) {
      <dt>Keywords</dt>
      <dd>
        @for(key <- a.keywords) {
          <a href="@routes.Application.index("",key, 1)">@key</a>, 
        }
      }
    </dl>
    <a class="btn btn-primary" href="@routes.FileServer.serve(a.original)">Download</a>

      @if(util.Settings.isAdmin) {
        <a href="#editAsset" role="button" class="btn" data-toggle="modal">Edit Metadata (Admin)</a>
      }
  </div>

 @******** Admin edit of asset metadata *****@

  @if(util.Settings.isAdmin) {
  <div id="editAsset" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
      <h3 id="myModalLabel">Edit Metadata: @{a.name}</h3>
    </div>
    <form action="@routes.Admin.editMetadata(a.original)">
      <fieldset>
        <div class="modal-body">
          <p>You can edit the description and keywords here, it will write out to a .json file and the reload all the assets to show you changes. To share these changes with other use a version control system like Git or Subversion.</p>
          <label>Description</label>
          <textarea name="description" id="description" rows="3"  class="input-block-level">@{a.description}</textarea>
          <label>Keywords</label>
          <input type="text" name="keywords" id="keywords"  class="input-block-level" value="@{a.keywords.mkString(", ")}"/>
        </div>
        <div class="modal-footer">
          <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
          <button class="btn btn-primary" type="submit">Save changes</button>
        </div>
      </fieldset>
    </form>
  </div>
  }

}


@pageLink(page: Int, text: String, nav: Boolean) = {
  <li @if(page == results.current) { 
        @if(nav) { class="disabled" } else { class="active" }
    } >
    <a 
    href="@if(currentFolder.isEmpty) { @routes.Application.index(search, keywordSearch,page) } else { @routes.Application.findFolder(currentFolder,page) }"
      >@text</a>
  </li> 
}





@*******************************
 * the actual page starts here 
 *@

@main(title) {

@********************************
 * Navigation bar 
 *@

<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <a class="brand titlebrand" href="#">@{title}</a>
    <ul class="nav">
      <li class="divider-vertical"></li>
      <li @if(search.isEmpty && currentFolder.isEmpty && individualAsset.isEmpty && keywordSearch.isEmpty) { class="active" } ><a href="/">Show All</a></li> 
      <form class="navbar-form pull-left form-search" action="@routes.Application.index()">
      <div class="input-append">
        <input type="text" class="span3 search-query"  name="search" id="search" value="@{search}">
        <button type="submit" class="btn">Search</button>
      </div>

      </form>
    </ul>

@if(results.total > 1) {
    <div class="pagination pagination-small pull-left pagination-in-navbar">
    <ul>
        @pageLink(1, "|<", true) 
        @pageLink(math.max(results.current - 1,1), "<", true)
        @for(p <- results.min to results.max)  {
            @pageLink(p, p.toString, false)
        }
        @pageLink(math.min(results.current + 1, results.total), ">", true)
        @pageLink(results.total, ">|", true)
    </ul>
    </div> 
}
    @**** todo: order ****@
    @* <li class="navbar-text">Order</li> *@

@if(util.Settings.isAdmin) {
  @* show admin *@
  <ul class="nav pull-right">
    <li class="dropdown">
      <a class="dropdown-toggle" data-toggle="dropdown" href="#">Admin
          <b class="caret"></b>
        </a>
      <ul class="dropdown-menu">
        <a href="@routes.Admin.rescan(request.uri)">Rescan Asset Library</a>
      </ul>
    </li>
  </ul>
}

  </div>
</div>


<div class="container-fluid rounded">
  <div class="row-fluid">

@*******************************
 * sidebar 
 *@

    <div class="span2 sidebar">
      <h5>Folders</h5>
      <div class="tree" id="folderTree" style="display:none;">
        @listFolders(library.topFolder.folders, "")
      </div>

      <h5>Keywords</h5>
      <div class="tree" id="keywordTree" style="display:none;">
        @listKeywords(library.keywords)
      </div>
    </div>

@*******************************
 * actual content 
 *@

    <div class="span10 content">
@if(individualAsset.isDefined) {
    @showIndividualAsset(individualAsset.get)  
} else {     
    @for(a <- results.assets) { @assetThumbnail(a) }
}
    </div>
  </div>
</div>

} @* end of main() call *@


@******************
 * scripts to run after other scripts are loaded ...
 * TODO: move these out to other js files to speed up loading
 *@

<script>
jQuery(document).ready(function() {

  // build a big lookup table from path -> node id
  var currentFolder = "@Html(currentFolder)";
  //console.log("looking for", currentFolder);
  var auto_open = [];
  var expect_select = false;
  // var nodes = [];
      
  // replace string path with hash id for easy lookup later...
  $(".tree li").each(function(index) { 
    var nodeName = $(this).attr("data-folder-path");
    var nodeId = "folder" + index;
    //nodes[ nodeName ] = nodeId; 
    $(this).attr("id", nodeId);

    if (nodeName === currentFolder) {
      auto_open.push("#" + nodeId);
      expect_select = true;
    } 
  });

  // create tree
  $("#folderTree").hide()
  .jstree({
      core: {
          "animation": 100,
          "open_parents": true
      },
      themes: { 
          "icons" : false,
          "theme": "classic",
          "url": "/web/tree-themes/classic/style.css"
      },
      ui: {
          "initially_select": auto_open
      }, 
      plugins: [ "themes",  "html_data", "ui" ]
  })
  .bind("select_node.jstree", function(e, data) {
    if (data.rslt.obj) {
      if (expect_select) {
        expect_select = false;
      } else {
        // redirect! (eventually, just submit query)
        window.location.href = data.rslt.obj.attr("data-query-url");
      }
    }
  }).show();


  var currentKeyword = "@Html(keywordSearch)";
  var keyword_to_open = [];
  var expect_keyword_select = false;
  // var keyNodes = [];

  $(".tree li").each(function(index) { 
    var nodeName = $(this).attr("data-keyword");
    var nodeId = "keyword" + index;
    //keyNodes[ nodeName ] = nodeId; 
    $(this).attr("id", nodeId);

    if (nodeName === currentKeyword) {
      keyword_to_open.push("#" + nodeId);
      expect_keyword_select = true;
    } 
  });

  $("#keywordTree").hide()
  .jstree({
      core: {
          "animation": 100
      },
      themes: { 
          "icons" : false,
          "theme": "classic",
          "url": "/web/tree-themes/classic/style.css"
      },
      ui: {
          "initially_select": keyword_to_open
      }, 
      plugins: [ "themes",  "html_data", "ui" ]
  })
  .bind("select_node.jstree", function(e, data) {
    if (data.rslt.obj) {
      if (expect_keyword_select) {
        expect_keyword_select = false;
      } else {
        // redirect! (eventually, just submit query)
        window.location.href = data.rslt.obj.attr("data-query-url");
      }
    }   
  }).show();
});
</script>

@* end page correctly *@
</body>
</html>

